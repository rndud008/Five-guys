<!DOCTYPE HTML>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" xmlns="http://www.w3.org/1999/html">
<head>
    <title th:text="${post.title}"></title>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">

    <link rel="stylesheet" href="/css/detail.css">
    <link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/map.css">
    <link rel="stylesheet" href="/css/nav.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <script src="https://kit.fontawesome.com/fcca3fae9a.js" crossorigin="anonymous"></script>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=22d9b94181d1047695b69ce686213e6a&libraries=services"></script>
    <script type="text/javascript" src="//wcs.naver.net/wcslog.js"></script>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=04f2a8050054f9bc4f2acd74c6e8c884&libraries=services"></script>
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KK8LFW3LEV"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        .like-container {
            display: flex;
            align-items: center;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
            color: #333;
        }

        /* 좋아요 버튼 스타일 */
        .like-button {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border: none;
            background-color: transparent;
            transition: transform 0.3s, color 0.3s;
        }

        .like-button:hover {
            transform: scale(1.1); /* 호버 시 버튼 약간 확대 */
            color: #007bff; /* 호버 시 색상 변경 */
        }

        /* 좋아요 아이콘 스타일 */
        .like-button i {
            margin-right: 5px;
            font-size: 18px; /* 아이콘 크기 조정 */
        }

        /* 좋아요 텍스트 스타일 */
        .like-text {
            margin-right: 5px;
        }

        /* 좋아요 수 스타일 */
        .like-count {
            margin-left: 10px;
            font-size: 14px;
            color: #888;
            transition: transform 0.3s ease;
        }

        /* 좋아요 수 증가 애니메이션 */
        .like-count.increment {
            transform: scale(1.2); /* 좋아요 수가 증가할 때 약간 확대 */
            color: #007bff; /* 좋아요 수가 증가할 때 색상 변경 */
        }
    </style>


</head>
<body>
<div id="postId" th:text="${post.id}" style="display: none;"></div>
<div id="wrap">
    <!-- header -->

    <th:block th:insert="~{fragment/navbar::navbar}"></th:block>
    <th:block th:insert="~{fragment/navbar::loginModal}"></th:block>

    <div class="bg-top"></div>


    <main>
        <section class="sub">
            <div class="view tour">
                <article class="content">
                    <div class="top-wrap">
                        <div class="tit">
                            <h2 th:utext="${post.title}"></h2>
                            <h1 class="txt"
                                th:text="${#strings.substring(post.eventstartdate, 2, 4)} + '.' + ${#strings.substring(post.eventstartdate, 4, 6)} + '.' + ${#strings.substring(post.eventstartdate, 6, 8)}+ ' ~ '+${#strings.substring(post.eventenddate, 2, 4)} + '.' + ${#strings.substring(post.eventenddate, 4, 6)} + '.' + ${#strings.substring(post.eventenddate, 6, 8)}"></h1>
                        </div>
                    </div>

                    <div class="gallery">
                        <img th:if="${!#strings.isEmpty(post.firstimage)}"
                             th:src="${post.firstimage}" alt="">
                    </div>


                    <div class="title">
                        <h4>상세정보</h4>
                    </div>
                    <div class="detail">
                        <p class="desc" th:utext="${post.overview}"></p>


                        <h5 class="hide">지도보기</h5>
                        <div class="map_wrap">
                            <div id="map" style="width:100%;height:100%;position:relative;overflow:hidden;"></div>
                            <ul id="category">
                                <li id="CE7" data-order="0">
                                    <span class="category_bg coffee"></span>
                                    카페
                                </li>
                                <li id="FD6" data-order="1">
                                    <span class="category_bg food"></span>
                                    음식점
                                </li>
                                <li id="PK6" data-order="2">
                                    <span class="category_bg park"></span>
                                    주차장
                                </li>
                            </ul>
                        </div>


                        <h5 class="hide">세부정보</h5>
                        <dl class="info">
                            <dt>홈페이지</dt>
                            <dd class="homepage">
                                <a th:if="${!#strings.isEmpty(post.homepage)}"
                                   th:href="${post.homepage}"
                                   target="_blank"
                                   th:text="${#strings.isEmpty(post.homepage) ? '없음' : post.homepage}">홈페이지</a>
                            </dd>
                            <dt>주소</dt>
                            <dd th:utext="${#strings.isEmpty(post.addr1) ? '없음' : post.addr1}"></dd>
                            <dt>문의 및 안내</dt>
                            <dd th:utext="${#strings.isEmpty(post.tel) ? '없음' : post.tel}"></dd>
                            <dt>축제/행사 장소</dt>
                            <dd th:utext="${#strings.isEmpty(post.addr2) ? '없음' : post.addr2}"></dd>
                            <dt>시간</dt>
                            <dd th:utext="${#strings.isEmpty(post.playtime) ? '축제별 상이' : post.playtime}"></dd>
                            <dt>이용요금</dt>
                            <dd th:utext="${#strings.isEmpty(post.usetimefestival) ? '없음' : post.usetimefestival}"></dd>
                            <dt>축제/행사 내용</dt>
                            <dd class="full" th:utext="${#strings.isEmpty(post.infotext) ? '없음' : post.infotext}"></dd>
                        </dl>
                    </div>

                    <div class="like-container">
                        <button class="like-button"></button>
                        <span class="like-count">0</span>
                    </div>

                    <div class="title justify">
                        <h4>관련 블로그 리뷰</h4>
                        <a th:href="'https://search.naver.com/search.naver?where=nexearch&sm=top_hty&fbm=0&ie=utf8&query=' + ${post.title}"
                           target="_blank" class="btn-search">네이버 검색 바로가기</a>
                    </div>
                    <div class="blog">
                        <ul id="blogList">
                            <li th:each="blog : ${blogReview}">
                                <div>
                                    <a th:href="${blog.link}" target="_blank" class="tit">
                                        <strong th:utext="${blog.title}"></strong>
                                        <span th:text="${#strings.substring(blog.postdate, 2, 4)} + '.' + ${#strings.substring(blog.postdate, 4, 6)} + '.' + ${#strings.substring(blog.postdate, 6, 8)}"></span>
                                    </a>
                                    <a th:href="${blog.link}" target="_blank" class="desc"
                                       th:utext="${blog.description}"></a>
                                </div>
                            </li>
                        </ul>
                        <button id="loadMore" onclick="loadMore()">블로그 더보기</button>
                    </div>
                </article>
            </div>
        </section>
    </main>
    <!-- //container -->

    <th:block th:insert="~{fragment/footer::footer}"></th:block>

</div>

<script th:inline="javascript" th:with="loggedUser=${loggedUser}">
    /*<![CDATA[*/
    var postId = [[${post.id}]];
    var postContentid = [[${post.contentid}]];
    var loggedUser = [[${loggedUser}]];
    /*]]>*/
</script>

<script type="text/javascript">
    let offset = 5; // 초기 offset 값 설정
    let totalBlogs = 0; // 총 블로그 개수

    $(document).ready(function () {
        // 페이지 로드 시 총 블로그 개수를 가져옴
        $.get("/api/festival/blogs/count", {id: postContentid}, function (data) {
            totalBlogs = data;
        });
    });

    function loadMore() {
        $.get("/api/festival/blogs", {id: postContentid, offset: offset}, function (data) {
            if (data.length > 0) {
                let blogList = $('#blogList');
                data.forEach(function (blog) {
                    blogList.append(
                        '<li>' +
                        '<div>' +
                        '<a href="' + blog.link + '" target="_blank" class="tit">' +
                        '<strong>' + blog.title + '</strong>' +
                        '<span>' + blog.postdate.substring(2, 4) + '.' + blog.postdate.substring(4, 6) + '.' + blog.postdate.substring(6, 8) + '</span>' +
                        '</a>' +
                        '<a href="' + blog.link + '" target="_blank" class="desc">' +
                        blog.description +
                        '</a>' +
                        '</div>' +
                        '</li>'
                    );
                });
                offset += 3; // 다음 요청을 위해 offset 값을 증가

                // 현재 로드된 블로그 수와 총 블로그 수를 비교
                if (offset >= totalBlogs) {
                    $('#loadMore').hide(); // 모든 블로그가 로드되면 "더보기" 버튼 숨기기
                }
            } else {
                $('#loadMore').hide(); // 더 이상 데이터가 없을 때 "더보기" 버튼 숨기기
            }
        });
    }
</script>


<script th:inline="javascript">
    var mapContainer = document.getElementById('map'); // 지도를 표시할 div
    var markers = []; // 모든 마커를 담을 배열
    var categoryMarkers = []; // 카테고리 검색 결과 마커를 담을 배열
    var post = /*[[${post}]]*/ {};

    var centerCoords = new kakao.maps.LatLng(post.mapy, post.mapx); // 초기 중심 좌표

    var mapOption = {
        center: centerCoords,
        level: 4 // 지도의 확대 레벨
    };

    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

    // 기존 마커 표시
    var markerPosition = new kakao.maps.LatLng(post.mapy, post.mapx);
    var marker = new kakao.maps.Marker({
        position: markerPosition,
    });
    marker.setMap(map); // 마커를 지도에 표시
    markers.push(marker); // markers 배열에 추가

    // 각 카테고리에 클릭 이벤트를 등록합니다
    var category = document.getElementById('category'),
        children = category.children;

    for (var i = 0; i < children.length; i++) {
        children[i].onclick = onClickCategory;
    }


    // 클릭된 카테고리에만 클릭된 스타일을 적용하는 함수입니다
    function changeCategoryClass(el) {
        for (var i = 0; i < children.length; i++) {
            children[i].className = '';
        }
        if (el) {
            el.className = 'on';
        }
    }

    // 카테고리를 클릭했을 때 호출되는 함수입니다
    function onClickCategory() {
        var id = this.id,
            className = this.className;

        hidePlaceInfo();

        if (className === 'on') {
            currCategory = ''; // 현재 카테고리 초기화
            changeCategoryClass(); // 모든 카테고리 클래스 제거
            removeCategoryMarkers(); // 카테고리 검색 결과 마커 제거
        } else {
            currCategory = id; // 현재 카테고리 설정
            changeCategoryClass(this); // 해당 카테고리 클래스 설정
            searchPlaces(); // 장소 검색 실행
        }
    }

    // 카테고리 검색을 요청하는 함수입니다
    function searchPlaces() {
        if (!currCategory) {
            return;
        }

        // 기존 카테고리 검색 결과 마커를 제거합니다
        removeCategoryMarkers();

        // 카테고리 검색 요청
        var ps = new kakao.maps.services.Places(map);
        ps.categorySearch(currCategory, placesSearchCB, {useMapBounds: true});
    }

    // 장소 검색이 완료된 후 호출되는 콜백 함수입니다
    function placesSearchCB(data, status, pagination) {
        if (status === kakao.maps.services.Status.OK) {
            // 검색 결과가 정상적으로 나왔을 때 마커 표시
            displayCategoryPlaces(data);
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
            // 검색 결과가 없을 때 처리
            console.log("검색 결과가 없습니다.");
        } else if (status === kakao.maps.services.Status.ERROR) {
            // 검색 중 오류 발생 시 처리
            console.error("검색 중 오류가 발생했습니다.");
        }
    }

    // 카테고리 검색 결과 마커를 모두 제거합니다
    function removeCategoryMarkers() {
        for (var i = 0; i < categoryMarkers.length; i++) {
            categoryMarkers[i].setMap(null);
        }
        categoryMarkers = []; // 배열 초기화
    }

    // 카테고리 검색 결과를 지도에 표시하는 함수입니다
    function displayCategoryPlaces(places) {
        for (var i = 0; i < places.length; i++) {
            var marker = addCategoryMarker(places[i]);
            categoryMarkers.push(marker); // categoryMarkers 배열에 추가
        }
    }

    // 카테고리 검색 결과 마커를 생성하고 지도에 표시하는 함수입니다
    function addCategoryMarker(place) {
        var imageSize = new kakao.maps.Size(35, 35), // 마커 이미지의 크기
            imageSrc = getImageSrc(currCategory), // 카테고리에 따른 마커 이미지 URL
            imgOptions = {
                offset: new kakao.maps.Point(18, 28) // 마커 좌표에 일치시킬 이미지 내에서의 좌표
            },
            markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
            markerPosition = new kakao.maps.LatLng(place.y, place.x);

        var marker = new kakao.maps.Marker({
            position: markerPosition,
            image: markerImage
        });

        marker.setMap(map); // 지도에 마커 표시
        kakao.maps.event.addListener(marker, 'click', function () {
            displayPlaceInfo(place); // 마커 클릭 시 상세 정보 표시
        });

        return marker;
    }

    // 카테고리에 따른 마커 이미지 URL을 반환하는 함수입니다
    function getImageSrc(category) {
        switch (category) {
            case 'CE7': // 카페
                return '/img/coffee.png';
            case 'FD6': // 음식점
                return '/img/food.png';
            case 'PK6': // 주차장
                return '/img/car.png';
            default:
                return '';
        }
    }

    // 클릭한 마커에 대한 장소 상세 정보를 커스텀 오버레이로 표시하는 함수입니다
    var placeOverlay = new kakao.maps.CustomOverlay({
        zIndex: 1
    });

    var contentNode = document.createElement('div');
    contentNode.className = 'placeinfo_wrap';

    addEventHandle(contentNode, 'mousedown', kakao.maps.event.preventMap);
    addEventHandle(contentNode, 'touchstart', kakao.maps.event.preventMap);

    placeOverlay.setContent(contentNode);

    function displayPlaceInfo(place) {
        var content = '<div class="placeinfo">' +
            '   <a class="title" href="' + place.place_url + '" target="_blank" title="' + place.place_name + '">' + place.place_name + '</a>';

        if (place.road_address_name) {
            content += '    <span title="' + place.road_address_name + '">' + place.road_address_name + '</span>' +
                '  <span class="jibun" title="' + place.address_name + '">(지번 : ' + place.address_name + ')</span>';
        } else {
            content += '    <span title="' + place.address_name + '">' + place.address_name + '</span>';
        }

        content += '    <span class="tel">' + place.phone + '</span>' +
            '</div>' +
            '<div class="after"></div>';

        contentNode.innerHTML = content;
        placeOverlay.setPosition(new kakao.maps.LatLng(place.y, place.x));
        placeOverlay.setMap(map);
    }

    function hidePlaceInfo() {
        placeOverlay.setMap(null);
    }

    // 엘리먼트에 이벤트 핸들러를 등록하는 함수입니다
    function addEventHandle(target, type, callback) {
        if (target.addEventListener) {
            target.addEventListener(type, callback);
        } else {
            target.attachEvent('on' + type, callback);
        }
    }

</script> <!--kakaomap-->

<script src="/js/nav.js"></script>
<script src="/js/travelLike.js"></script>
<script src="/js/modallogin.js"></script>
</body>
</html>